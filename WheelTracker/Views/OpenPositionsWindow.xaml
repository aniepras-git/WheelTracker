<Window x:Class="WheelTracker.Views.OpenPositionsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:WheelTracker.ViewModels"
        Title="Open Positions" Height="750" Width="1600">

    <Window.DataContext>
        <vm:OpenPositionsViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <vm:ClosedToBoolConverter x:Key="ClosedToBoolConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Filters & Save Button -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="8">
            <CheckBox Content="Open only" IsChecked="{Binding ShowOnlyOpen}" Margin="0,0,12,0"/>
            <TextBlock Text="Ticker:" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <TextBox Width="130" Text="{Binding FilterTicker, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,12,0"/>
            <Button Content="Refresh" Command="{Binding LoadCommand}" Width="80" Margin="0,0,12,0"/>
            <Button Content="Save All Changes" Command="{Binding SaveChangesCommand}" 
                    Width="140" Background="#FF007ACC" Foreground="White" FontWeight="SemiBold"/>
        </StackPanel>

        <!-- FULLY EDITABLE DATAGRID -->
        <DataGrid Grid.Row="1" ItemsSource="{Binding Trades}" AutoGenerateColumns="False"
                  CanUserAddRows="False" CanUserDeleteRows="False"
                  AlternatingRowBackground="#FFF5F5F5" RowHeight="28">

            <DataGrid.Columns>
                <!-- READ-ONLY -->
                <DataGridTextColumn Header="Ticker" Binding="{Binding Ticker}" IsReadOnly="True" Width="80"/>
                <DataGridTextColumn Header="Open Date" Binding="{Binding OpenDate, StringFormat=d}" IsReadOnly="True" Width="100"/>
                <DataGridTextColumn Header="Action" Binding="{Binding Action}" IsReadOnly="True" Width="80"/>
                <DataGridTextColumn Header="Strategy" Binding="{Binding Strategy}" IsReadOnly="True" Width="80"/>
                <DataGridTextColumn Header="Credit/Debit" Binding="{Binding CreditDebit}" IsReadOnly="True" Width="100"/>
                <DataGridTextColumn Header="Price at Open" Binding="{Binding PriceAtOpen, StringFormat=C2}" IsReadOnly="True" Width="110"/>
                <DataGridTextColumn Header="Expiration" Binding="{Binding Expiration, StringFormat=d}" IsReadOnly="True" Width="100"/>
                <DataGridTextColumn Header="Strike" Binding="{Binding Strike, StringFormat=C2}" IsReadOnly="True" Width="80"/>
                <DataGridTextColumn Header="Qty" Binding="{Binding Qty}" IsReadOnly="True" Width="60"/>
                <DataGridTextColumn Header="Premium" Binding="{Binding Premium, StringFormat=C2}" IsReadOnly="True" Width="90"/>
                <DataGridTextColumn Header="Fees" Binding="{Binding Fees, StringFormat=C2}" IsReadOnly="True" Width="70"/>
                <DataGridTextColumn Header="Initial DTE" Binding="{Binding InitialDTE}" IsReadOnly="True" Width="90"/>
                <DataGridTextColumn Header="DTE" Binding="{Binding DTE}" IsReadOnly="True" Width="60"/>
                <DataGridTextColumn Header="Moneyness" Binding="{Binding Moneyness, StringFormat=P2}" IsReadOnly="True" Width="90"/>

                <!-- EDITABLE -->
                <DataGridComboBoxColumn Header="Status"
                                        ItemsSource="{Binding Source={x:Static vm:EnumHelper.StatusTypes}}"
                                        SelectedItemBinding="{Binding Status, UpdateSourceTrigger=PropertyChanged}"
                                        Width="90"/>

                <DataGridTemplateColumn Header="Close Date" Width="100">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <DatePicker SelectedDate="{Binding CloseDate, UpdateSourceTrigger=PropertyChanged}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTemplateColumn Header="Close Trans Type" Width="120">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ComboBox ItemsSource="{Binding Source={x:Static vm:EnumHelper.CloseTypes}}"
                      SelectedItem="{Binding CloseTransType, UpdateSourceTrigger=PropertyChanged}"
                      IsEnabled="{Binding Status, Converter={StaticResource ClosedToBoolConverter}}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Close Qty" 
                                    Binding="{Binding CloseQty, UpdateSourceTrigger=PropertyChanged}" 
                                    Width="80"/>
                <DataGridTextColumn Header="Close Price" 
                                    Binding="{Binding ClosePrice, UpdateSourceTrigger=PropertyChanged, StringFormat=C2}" 
                                    Width="100"/>
                <DataGridTextColumn Header="Close Fee" 
                                    Binding="{Binding CloseFee, UpdateSourceTrigger=PropertyChanged, StringFormat=C2}" 
                                    Width="80"/>
                <DataGridTextColumn Header="Days Held" 
                                    Binding="{Binding DaysHeld, UpdateSourceTrigger=PropertyChanged}" 
                                    Width="90"/>

                <!-- AUTO-CALCULATED -->
                <DataGridTextColumn Header="Total" Binding="{Binding Total, StringFormat=C2}" IsReadOnly="True" Width="80"/>
                <DataGridTextColumn Header="Return %" Binding="{Binding CalculatedReturn, StringFormat=P2}" IsReadOnly="True" Width="80"/>
                <DataGridTextColumn Header="Annual Return %" Binding="{Binding AnnualReturn, StringFormat=P2}" IsReadOnly="True" Width="100"/>
                <DataGridTextColumn Header="Realized G/L" Binding="{Binding RealizedGainLoss, StringFormat=C2}" IsReadOnly="True" Width="100"/>
                <DataGridTextColumn Header="Unrealized G/L" Binding="{Binding UnrealizedGainLoss, StringFormat=C2}" IsReadOnly="True" Width="110"/>
            </DataGrid.Columns>
        </DataGrid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="2" Background="#FF007ACC" Foreground="White">
            <StatusBarItem Content="{Binding StatusMessage}"/>
        </StatusBar>
    </Grid>
</Window>